var CacheDataManager=function(a){this.MAX_CELL_COUNT=140;this.delta=2;this.dataViewer=a;this.contextPath=a.contextPath;this.reportId=a.reportId;this.filePath=a.filePath;this.reportType=a.reportType;this.width=0;this.height=0;this.reportHeight=0;this.groupFields=null;this.selectFields=null;this.css=null;this.colWidth=null;this.rowHeight=null;this.reportTitle=null;this.reportFoot=null;this.recodePosition=null;this.recodeCount=0;this.headerId=null;this.groupStyle=1;this.newData=[];this.data=[];this.deltaSize=0;this.position=0;this.dataHeight=0;this.dataWidth=0;this.tableFirst=0;this.realDataHeight=0;var b=new Base64();this.rowNo=[];this.realReportHeight=0;var c=this;this.loading=function(){$("body").append("<div style='width:100;height:100;position:absolute;z-index:0; top:0; left:0;background-color:#f2f2f2'></div>");loading()};this.calcReport=function(){if(c.dataViewer.reportType=="fast"){var d=false;$.ajax({type:"POST",url:c.contextPath+"/showFastReportServlet?action=0",async:false,cache:false,data:{resID:b.encode(c.reportId),fastReportDir:b.encode(c.filePath)},dataType:"json",success:function(e,f){if(e.error==false){d=true}else{d=false}},error:function(e,g,f){confirm("请求数据出错："+g+","+f)}});return d}else{if(c.dataViewer.reportType=="pivot"){$.ajax({type:"POST",url:c.contextPath+"/showPivotReportServlet?action=0",cache:false,data:{resID:b.encode(c.reportId),pivotReportDir:b.encode(c.filePath)},dataType:"json",success:function(g,h){if(g.error==false){g=g.data;c.title=g.title;c.foot=g.foot;c.css=g.css;c.colWidth=g.colWidth;c.rowHeight=g.rowHeight;c.headerId=g.headerId;c.width=g.width;c.dataViewer.colCount=g.width;var f=new Date().getMilliseconds();c.dataViewer.createTable(g.data).createTitle().createFoot();var e=new Date().getMilliseconds();alert("前端表格处理用时："+(e-f))}else{alert(g.data)}},error:function(e,g,f){confirm("请求数据出错："+g+","+f)}})}else{confirm("不支持的报表类型！")}}};this.getReportInfo=function(){var d=false;$.ajax({type:"POST",url:c.contextPath+"/showFastReportServlet?action=13",async:false,cache:false,data:{resID:b.encode(c.reportId)},dataType:"json",success:function(e,f){if(e.error==false){e=e.data;c.title=e.title;c.foot=e.foot;c.css=e.css;c.groupFields=e.groupFields;c.selectFields=e.selectFields;c.colWidth=e.colWidth;c.rowHeight=e.rowHeight;c.recodePosition=e.recodePosition;c.recodeCount=e.recodeCount;c.groupStyle=e.groupStyle;c.width=e.width;c.height=parseInt(c.MAX_CELL_COUNT/c.width);c.reportHeight=parseInt(e.height);c.dataWidth=parseInt(e.width);c.realReportHeight=c.reportHeight;d=true}else{d=false}},error:function(e,g,f){confirm("请求数据出错："+g+","+f)}});return d};this.getData=function(e,g){if(e>=this.position&&e+g<=this.position+this.dataHeight){}else{if(e>=this.position&&e+g>this.position+this.dataHeight&&e+g<=this.position+this.height){var i=this.position+this.dataHeight;var f=e+g-i;if(f<this.deltaSize){f=this.deltaSize}if(i+f>=this.position+this.height){f=this.position+this.height-i}if(i+f>=this.reportHeight){f=this.reportHeight-i}this.data=this.data.concat(this.getDataFromServer(i,f));this.dataHeight=this.data.length/this.dataWidth}else{if(e<this.position&&(this.position-e)<=this.height){var i=e;var f=this.position-i;if(f<this.deltaSize){f=this.deltaSize;i=this.position-f}if(i<0){i=0;f=this.position-i}var d=this.getDataFromServer(i,f);d=d.concat(this.data.splice(0,((this.dataHeight-((this.position-i+this.dataHeight)-this.height)))*this.dataWidth));this.data=d;this.dataHeight=this.data.length/this.dataWidth;this.position=i}else{if(e<this.position&&(this.position-e)>this.height){var i=e;var f=this.deltaSize;if(i+f>=this.reportHeight){f=this.reportHeight-i}this.data=this.getDataFromServer(i,f);this.position=i;this.dataHeight=f}else{if(e+g>(this.position+this.dataHeight)&&(e+g)-(this.position+this.dataHeight)<=this.height){var i=this.position+this.dataHeight;var f=e+g-i;if(f<this.deltaSize){f=this.deltaSize}if(i+f>=this.reportHeight){f=this.reportHeight-i}this.data.splice(0,f*this.dataWidth);this.data=this.data.concat(this.getDataFromServer(i,f));this.dataHeight=this.data.length/this.dataWidth;this.position+=f}else{if(e+g>(this.position+this.dataHeight)&&(e+g)-(this.position+this.dataHeight)>this.height){var i=e;var f=this.deltaSize;if(i+f>=this.reportHeight){f=this.reportHeight-i}this.data=this.getDataFromServer(i,f);this.position=i;this.dataHeight=f}}}}}}var h=this.data.slice((e-this.position)*this.dataWidth,(e+g-this.position)*this.dataWidth);return h};this.addRowNo=function(f){var e=this.position;for(var d=0;d<f.length;d++){f[d].no=e+parseInt(d/this.dataWidth)}return f};this.getDataFromServer=function(e,f){var d=null;alert("后台取数："+e+"~"+(e+f));$.ajax({type:"POST",url:c.contextPath+"/showFastReportServlet?action=2",cache:false,async:false,data:{rowBegin:""+e,rowCount:""+f,resID:b.encode(c.reportId),type:"detail",groupFields:b.encode(c.groupFields),selectFields:b.encode(c.selectFields)},dataType:"json",success:function(g,h){if(g.error==false){d=g.data}else{confirm(g.data)}},error:function(g,i,h){confirm("请求数据出错："+i+","+h)}});alert(d.length);return d};this.fold=function(d){$.ajax({type:"POST",url:c.contextPath+"/showFastReportServlet?action=3",cache:false,async:false,data:{resID:b.encode(c.reportId),groupFields:b.encode(c.groupFields),selectFields:b.encode(c.selectFields),title:b.encode(d.title),valueIndex:d.vi,index:d.no},dataType:"json",success:function(e,f){if(e.error==false){c.data=[]}else{confirm(e.data);return}},error:function(e,g,f){confirm("请求数据出错："+g+","+f)}})};this.unfold=function(e){var d=$(e).parent().attr("rowNum");$.ajax({type:"POST",url:c.contextPath+"/showFastReportServlet?action=4",cache:false,async:false,data:{resID:b.encode(c.reportId),groupFields:b.encode(c.groupFields),selectFields:b.encode(c.selectFields),title:b.encode(e.title),begin:e.rb,length:e.rc},dataType:"json",success:function(f,g){if(f.error==false){c.data=[]}else{confirm(f.data);return}},error:function(f,h,g){confirm("请求数据出错："+h+","+g)}})};this.foldAll=function(d){$.ajax({type:"POST",url:c.contextPath+"/showFastReportServlet?action=5",cache:false,async:false,data:{resID:b.encode(c.reportId),groupFields:b.encode(c.groupFields),selectFields:b.encode(c.selectFields),title:b.encode(d.title),begin:d.rb,length:d.rc},dataType:"json",success:function(e,f){if(e.error==false){c.data=[];c.dataHeight=0}else{confirm(e.data);return}},error:function(e,g,f){confirm("请求数据出错："+g+","+f)}})};this.unfoldAll=function(d){$.ajax({type:"POST",url:c.contextPath+"/showFastReportServlet?action=6",cache:false,async:false,data:{resID:b.encode(c.reportId),groupFields:b.encode(c.groupFields),selectFields:b.encode(c.selectFields),title:b.encode(d.title),begin:d.rb,length:d.rc},dataType:"json",success:function(e,f){if(e.error==false){c.data=[];c.dataHeight=0}else{confirm(e.data);return}},error:function(e,g,f){confirm("请求数据出错："+g+","+f)}})};this.resetData=function(d,e,g){var i=(d-this.position)*this.dataWidth;var f=e*this.dataWidth;var h=this.data.splice(0,i);h=h.concat(g.splice(0,f));this.data.splice(0,f);h=h.concat(this.data);this.data=h;h=null};this.checkExist=function(f){var d=0;for(var e=0;e<c.dataWidth;e++){if(c.data[f+e].v==c.data[f-c.dataWidth+e].v){d++}}return d==this.dataWidth};this.clearCache=function(){var d=(c.reportType=="fast"?"/showFastReportServlet":"/showPivotReportServlet")+"?action=7&resID="+b.encode(c.reportId);window.top.location.href=c.contextPath+d}};function cloneColObj(b){var a={};a.v=b.v;a.t=b.t;a.s=b.s;a.vi=b.vi;a.tt=b.tt;a.a=b.a;a.dl=b.dl;return a};